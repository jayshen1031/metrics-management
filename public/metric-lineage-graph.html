<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡æ ‡è¡€ç¼˜å…³ç³»å›¾è°± - æŒ‡æ ‡ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', 'Arial', sans-serif;
            background: #f0f2f5;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .toolbar-title {
            font-size: 20px;
            font-weight: 600;
            color: #1890ff;
            margin-right: 40px;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 40px 8px 15px;
            border: 1px solid #d9d9d9;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8c8c8c;
            cursor: pointer;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            color: #595959;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            color: #1890ff;
            border-color: #1890ff;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
            border-color: #40a9ff;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            width: 280px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 999;
            transition: transform 0.3s;
        }
        
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 15px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            font-size: 14px;
            color: #595959;
            margin-bottom: 8px;
            display: block;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #595959;
            cursor: pointer;
        }
        
        .checkbox-item input {
            margin-right: 8px;
        }
        
        /* ä¸»ç”»å¸ƒ */
        .main-container {
            position: fixed;
            left: 280px;
            top: 60px;
            right: 0;
            bottom: 0;
            transition: left 0.3s;
        }
        
        .main-container.expanded {
            left: 0;
        }
        
        #graph-container {
            width: 100%;
            height: 100%;
            background: #fafafa;
        }
        
        /* èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ */
        .detail-panel {
            position: fixed;
            right: -400px;
            top: 60px;
            bottom: 0;
            width: 400px;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 998;
            transition: right 0.3s;
        }
        
        .detail-panel.visible {
            right: 0;
        }
        
        .detail-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
        }
        
        .detail-close {
            font-size: 20px;
            color: #8c8c8c;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .detail-content {
            padding: 20px;
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #8c8c8c;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 14px;
            color: #262626;
        }
        
        /* å›¾ä¾‹ */
        .legend {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 997;
        }
        
        .legend-title {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 10px;
        }
        
        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #595959;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æç¤ºæ¡† */
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1001;
        }
        
        /* èŠ‚ç‚¹æ ·å¼ */
        .node {
            cursor: pointer;
        }
        
        .node.highlighted {
            stroke-width: 3px;
            stroke: #ff4d4f;
        }
        
        .node.dimmed {
            opacity: 0.3;
        }
        
        .link {
            fill: none;
            stroke: #d9d9d9;
            stroke-width: 1.5px;
        }
        
        .link.highlighted {
            stroke: #1890ff;
            stroke-width: 3px;
        }
        
        .link.dimmed {
            opacity: 0.2;
        }
        
        .link-arrow {
            fill: #d9d9d9;
        }
        
        .link-arrow.highlighted {
            fill: #1890ff;
        }
        
        /* èŠ‚ç‚¹æ ‡ç­¾ */
        .node-label {
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        /* ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: fixed;
            left: 300px;
            bottom: 20px;
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 996;
        }
        
        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            color: #595959;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .zoom-btn:hover {
            color: #1890ff;
            background: #f0f0f0;
        }
        
        .zoom-btn:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .zoom-btn:last-child {
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-title">ğŸ“Š æŒ‡æ ‡è¡€ç¼˜å…³ç³»å›¾è°±</div>
        
        <div class="search-box">
            <input type="text" class="search-input" placeholder="æœç´¢æŒ‡æ ‡ã€è¡¨ã€å­—æ®µ..." id="searchInput">
            <span class="search-icon">ğŸ”</span>
        </div>
        
        <div class="toolbar-actions">
            <button class="btn" id="toggleSidebar">â˜° ç­›é€‰</button>
            <button class="btn" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
            <button class="btn" id="layoutBtn">ğŸ“ å¸ƒå±€</button>
            <button class="btn btn-primary" id="exportBtn">ğŸ’¾ å¯¼å‡º</button>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">èŠ‚ç‚¹ç±»å‹ç­›é€‰</div>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" value="Table" checked> ğŸ“Š æ•°æ®è¡¨
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="Field" checked> ğŸ”¤ å­—æ®µ
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="Metric" checked> ğŸ“ˆ æŒ‡æ ‡
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="Report" checked> ğŸ“‘ æŠ¥è¡¨
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="Dashboard" checked> ğŸ“Š çœ‹æ¿
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="API" checked> ğŸ”Œ API
                </label>
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">æ•æ„Ÿçº§åˆ«</div>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" value="public" checked> ğŸŸ¢ å…¬å¼€
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="internal" checked> ğŸŸ¡ å†…éƒ¨
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="sensitive" checked> ğŸŸ  æ•æ„Ÿ
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="confidential" checked> ğŸ”´ æœºå¯†
                </label>
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">é‡è¦ç­‰çº§</div>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" value="P0" checked> P0 - æ ¸å¿ƒæŒ‡æ ‡
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="P1" checked> P1 - é‡è¦æŒ‡æ ‡
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="P2" checked> P2 - ä¸€èˆ¬æŒ‡æ ‡
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" value="P3" checked> P3 - å‚è€ƒæŒ‡æ ‡
                </label>
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">æ˜¾ç¤ºé€‰é¡¹</div>
            <div class="filter-group">
                <label class="filter-label">æ˜¾ç¤ºæ·±åº¦</label>
                <select id="depthSelect" style="width: 100%; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px;">
                    <option value="1">1å±‚</option>
                    <option value="2" selected>2å±‚</option>
                    <option value="3">3å±‚</option>
                    <option value="4">4å±‚</option>
                    <option value="5">5å±‚</option>
                </select>
            </div>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="showLabels" checked> æ˜¾ç¤ºæ ‡ç­¾
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="showArrows" checked> æ˜¾ç¤ºç®­å¤´
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="animateLayout" checked> åŠ¨ç”»æ•ˆæœ
                </label>
            </div>
        </div>
    </div>
    
    <!-- ä¸»ç”»å¸ƒ -->
    <div class="main-container" id="mainContainer">
        <svg id="graph-container"></svg>
    </div>
    
    <!-- èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <div class="detail-title" id="detailTitle">èŠ‚ç‚¹è¯¦æƒ…</div>
            <button class="detail-close" id="closeDetail">Ã—</button>
        </div>
        <div class="detail-content" id="detailContent">
            <!-- åŠ¨æ€å¡«å…… -->
        </div>
    </div>
    
    <!-- å›¾ä¾‹ -->
    <div class="legend">
        <div class="legend-title">å›¾ä¾‹</div>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-icon" style="background: #1890ff;"></div>
                <span>æ•°æ®è¡¨</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #52c41a;"></div>
                <span>å­—æ®µ</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #fa8c16;"></div>
                <span>æŒ‡æ ‡</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #722ed1;"></div>
                <span>æŠ¥è¡¨</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #eb2f96;"></div>
                <span>çœ‹æ¿</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #13c2c2;"></div>
                <span>API</span>
            </div>
        </div>
    </div>
    
    <!-- ç¼©æ”¾æ§åˆ¶ -->
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomReset">âŸ²</button>
        <button class="zoom-btn" id="zoomOut">-</button>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p style="margin-top: 10px; color: #8c8c8c;">åŠ è½½ä¸­...</p>
    </div>
    
    <!-- æç¤ºæ¡† -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // å…¨å±€é…ç½®
        const config = {
            nodeColors: {
                'Table': '#1890ff',
                'Field': '#52c41a',
                'Metric': '#fa8c16',
                'Report': '#722ed1',
                'Dashboard': '#eb2f96',
                'API': '#13c2c2'
            },
            nodeSizes: {
                'Table': 40,
                'Field': 30,
                'Metric': 50,
                'Report': 40,
                'Dashboard': 40,
                'API': 35
            },
            linkColors: {
                'DEPENDS_ON': '#1890ff',
                'READS': '#52c41a',
                'USES': '#722ed1',
                'CALLS': '#13c2c2'
            }
        };

        // åˆå§‹åŒ–å˜é‡
        let svg, g, simulation, link, node, nodeLabel;
        let graphData = { nodes: [], links: [] };
        let selectedNode = null;
        let currentZoom = d3.zoomIdentity;

        // åˆå§‹åŒ–SVG
        function initSVG() {
            const container = d3.select('#graph-container');
            const width = container.node().clientWidth;
            const height = container.node().clientHeight;

            svg = container
                .attr('width', width)
                .attr('height', height);

            // å®šä¹‰ç®­å¤´æ ‡è®°
            svg.append('defs').selectAll('marker')
                .data(['default', 'highlighted'])
                .enter().append('marker')
                .attr('id', d => `arrow-${d}`)
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('class', d => `link-arrow ${d}`);

            g = svg.append('g');

            // åˆå§‹åŒ–åŠ›å¯¼å‘å›¾
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-500))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => config.nodeSizes[d.type] + 10));

            // ç¼©æ”¾è¡Œä¸º
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    currentZoom = event.transform;
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);
        }

        // åŠ è½½æ•°æ®
        async function loadData(metricCode = 'DAU') {
            document.getElementById('loading').style.display = 'block';
            
            try {
                // æ¨¡æ‹Ÿä»APIè·å–æ•°æ®
                // const response = await fetch(`/api/v1/lineage/metric/${metricCode}?depth=${depth}`);
                // const data = await response.json();
                
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                graphData = generateMockData(metricCode);
                
                updateGraph();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
        function generateMockData(centerMetric) {
            const nodes = [
                // è¡¨èŠ‚ç‚¹
                { id: 'dw.user_activity_log', name: 'ç”¨æˆ·æ´»åŠ¨æ—¥å¿—è¡¨', type: 'Table', database: 'dw', sensitivity: 'internal' },
                { id: 'dw.order_detail', name: 'è®¢å•æ˜ç»†è¡¨', type: 'Table', database: 'dw', sensitivity: 'sensitive' },
                { id: 'dim.user_info', name: 'ç”¨æˆ·ä¿¡æ¯ç»´è¡¨', type: 'Table', database: 'dim', sensitivity: 'sensitive' },
                
                // å­—æ®µèŠ‚ç‚¹
                { id: 'dw.user_activity_log.user_id', name: 'user_id', type: 'Field', table: 'dw.user_activity_log', dataType: 'bigint' },
                { id: 'dw.user_activity_log.event_time', name: 'event_time', type: 'Field', table: 'dw.user_activity_log', dataType: 'timestamp' },
                { id: 'dw.order_detail.order_amount', name: 'order_amount', type: 'Field', table: 'dw.order_detail', dataType: 'decimal' },
                { id: 'dw.order_detail.user_id', name: 'user_id', type: 'Field', table: 'dw.order_detail', dataType: 'bigint' },
                
                // æŒ‡æ ‡èŠ‚ç‚¹
                { id: 'DAU', name: 'æ—¥æ´»è·ƒç”¨æˆ·æ•°', type: 'Metric', importance: 'P0', sensitivity: 'internal', formula: 'COUNT(DISTINCT user_id)' },
                { id: 'GMV_DAILY', name: 'æ—¥äº¤æ˜“æ€»é¢', type: 'Metric', importance: 'P0', sensitivity: 'sensitive', formula: 'SUM(order_amount)' },
                { id: 'ARPU', name: 'ç”¨æˆ·å¹³å‡æ”¶å…¥', type: 'Metric', importance: 'P1', sensitivity: 'sensitive', formula: 'GMV_DAILY / DAU' },
                { id: 'NEW_USERS', name: 'æ–°å¢ç”¨æˆ·æ•°', type: 'Metric', importance: 'P1', sensitivity: 'internal', formula: 'COUNT(DISTINCT new_user_id)' },
                
                // æŠ¥è¡¨èŠ‚ç‚¹
                { id: 'daily_operation_report', name: 'æ¯æ—¥è¿è¥æŠ¥è¡¨', type: 'Report', owner: 'è¿è¥éƒ¨' },
                { id: 'weekly_business_report', name: 'å‘¨åº¦ä¸šåŠ¡æŠ¥è¡¨', type: 'Report', owner: 'ä¸šåŠ¡éƒ¨' },
                
                // çœ‹æ¿èŠ‚ç‚¹
                { id: 'executive_dashboard', name: 'é«˜ç®¡çœ‹æ¿', type: 'Dashboard', owner: 'ç®¡ç†å±‚' },
                { id: 'realtime_monitor', name: 'å®æ—¶ç›‘æ§å¤§å±', type: 'Dashboard', owner: 'æŠ€æœ¯éƒ¨' },
                
                // APIèŠ‚ç‚¹
                { id: 'metric_query_api', name: 'æŒ‡æ ‡æŸ¥è¯¢API', type: 'API', endpoint: '/api/metrics/query' },
                { id: 'data_export_api', name: 'æ•°æ®å¯¼å‡ºAPI', type: 'API', endpoint: '/api/data/export' }
            ];

            const links = [
                // è¡¨åˆ°å­—æ®µ
                { source: 'dw.user_activity_log', target: 'dw.user_activity_log.user_id', type: 'HAS_FIELD' },
                { source: 'dw.user_activity_log', target: 'dw.user_activity_log.event_time', type: 'HAS_FIELD' },
                { source: 'dw.order_detail', target: 'dw.order_detail.order_amount', type: 'HAS_FIELD' },
                { source: 'dw.order_detail', target: 'dw.order_detail.user_id', type: 'HAS_FIELD' },
                
                // æŒ‡æ ‡ä¾èµ–å­—æ®µ
                { source: 'DAU', target: 'dw.user_activity_log.user_id', type: 'READS' },
                { source: 'GMV_DAILY', target: 'dw.order_detail.order_amount', type: 'READS' },
                
                // æŒ‡æ ‡ä¾èµ–æŒ‡æ ‡
                { source: 'ARPU', target: 'DAU', type: 'DEPENDS_ON' },
                { source: 'ARPU', target: 'GMV_DAILY', type: 'DEPENDS_ON' },
                
                // æŠ¥è¡¨ä½¿ç”¨æŒ‡æ ‡
                { source: 'daily_operation_report', target: 'DAU', type: 'USES' },
                { source: 'daily_operation_report', target: 'GMV_DAILY', type: 'USES' },
                { source: 'daily_operation_report', target: 'NEW_USERS', type: 'USES' },
                { source: 'weekly_business_report', target: 'ARPU', type: 'USES' },
                
                // çœ‹æ¿å±•ç¤ºæŒ‡æ ‡
                { source: 'executive_dashboard', target: 'DAU', type: 'DISPLAYS' },
                { source: 'executive_dashboard', target: 'GMV_DAILY', type: 'DISPLAYS' },
                { source: 'executive_dashboard', target: 'ARPU', type: 'DISPLAYS' },
                { source: 'realtime_monitor', target: 'DAU', type: 'DISPLAYS' },
                
                // APIè°ƒç”¨æŒ‡æ ‡
                { source: 'metric_query_api', target: 'DAU', type: 'CALLS' },
                { source: 'metric_query_api', target: 'GMV_DAILY', type: 'CALLS' },
                { source: 'data_export_api', target: 'ARPU', type: 'CALLS' }
            ];

            return { nodes, links };
        }

        // æ›´æ–°å›¾å½¢
        function updateGraph() {
            // æ¸…ç©ºç°æœ‰å†…å®¹
            g.selectAll('*').remove();

            // åˆ›å»ºè¿çº¿
            link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(graphData.links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke', d => config.linkColors[d.type] || '#d9d9d9')
                .attr('marker-end', 'url(#arrow-default)');

            // åˆ›å»ºèŠ‚ç‚¹ç»„
            const nodeGroup = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(graphData.nodes)
                .enter().append('g')
                .attr('class', 'node-group')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // åˆ›å»ºèŠ‚ç‚¹
            node = nodeGroup.append('circle')
                .attr('class', 'node')
                .attr('r', d => config.nodeSizes[d.type] || 30)
                .attr('fill', d => config.nodeColors[d.type] || '#999')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .on('click', handleNodeClick)
                .on('mouseover', handleNodeHover)
                .on('mouseout', handleNodeLeave);

            // åˆ›å»ºèŠ‚ç‚¹å›¾æ ‡
            nodeGroup.append('text')
                .attr('class', 'node-icon')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'central')
                .attr('font-size', d => config.nodeSizes[d.type] * 0.5)
                .text(d => getNodeIcon(d.type));

            // åˆ›å»ºèŠ‚ç‚¹æ ‡ç­¾
            nodeLabel = nodeGroup.append('text')
                .attr('class', 'node-label')
                .attr('y', d => config.nodeSizes[d.type] + 15)
                .text(d => d.name);

            // æ›´æ–°åŠ›å¯¼å‘å›¾
            simulation
                .nodes(graphData.nodes)
                .on('tick', ticked);

            simulation.force('link')
                .links(graphData.links);

            simulation.alpha(1).restart();
        }

        // è·å–èŠ‚ç‚¹å›¾æ ‡
        function getNodeIcon(type) {
            const icons = {
                'Table': 'ğŸ“Š',
                'Field': 'ğŸ”¤',
                'Metric': 'ğŸ“ˆ',
                'Report': 'ğŸ“‘',
                'Dashboard': 'ğŸ“Š',
                'API': 'ğŸ”Œ'
            };
            return icons[type] || 'â—';
        }

        // åŠ›å¯¼å‘å›¾æ›´æ–°
        function ticked() {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            nodeLabel
                .attr('x', d => d.x)
                .attr('y', d => d.y + config.nodeSizes[d.type] + 15);

            d3.selectAll('.node-icon')
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        }

        // æ‹–æ‹½åŠŸèƒ½
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
        function handleNodeClick(event, d) {
            event.stopPropagation();
            selectedNode = d;
            highlightConnections(d);
            showNodeDetails(d);
        }

        // èŠ‚ç‚¹æ‚¬åœäº‹ä»¶
        function handleNodeHover(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${d.name}</strong><br>
                ç±»å‹: ${d.type}<br>
                ${d.formula ? `å…¬å¼: ${d.formula}` : ''}
                ${d.sensitivity ? `æ•æ„Ÿçº§åˆ«: ${d.sensitivity}` : ''}
            `;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.style.opacity = 1;
        }

        // èŠ‚ç‚¹ç¦»å¼€äº‹ä»¶
        function handleNodeLeave() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = 0;
        }

        // é«˜äº®è¿æ¥
        function highlightConnections(d) {
            // è·å–æ‰€æœ‰ç›¸å…³çš„èŠ‚ç‚¹å’Œè¿çº¿
            const connectedNodeIds = new Set();
            const connectedLinks = new Set();

            graphData.links.forEach(link => {
                if (link.source.id === d.id || link.target.id === d.id) {
                    connectedNodeIds.add(link.source.id);
                    connectedNodeIds.add(link.target.id);
                    connectedLinks.add(link);
                }
            });

            // æ›´æ–°èŠ‚ç‚¹æ ·å¼
            node.classed('highlighted', n => n.id === d.id)
                .classed('dimmed', n => !connectedNodeIds.has(n.id));

            // æ›´æ–°è¿çº¿æ ·å¼
            link.classed('highlighted', l => connectedLinks.has(l))
                .classed('dimmed', l => !connectedLinks.has(l))
                .attr('marker-end', l => connectedLinks.has(l) ? 'url(#arrow-highlighted)' : 'url(#arrow-default)');
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        function showNodeDetails(d) {
            const detailPanel = document.getElementById('detailPanel');
            const detailTitle = document.getElementById('detailTitle');
            const detailContent = document.getElementById('detailContent');

            detailTitle.textContent = d.name;
            
            let content = `
                <div class="detail-item">
                    <div class="detail-label">èŠ‚ç‚¹ç±»å‹</div>
                    <div class="detail-value">${d.type}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">èŠ‚ç‚¹ID</div>
                    <div class="detail-value">${d.id}</div>
                </div>
            `;

            // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ·»åŠ ç‰¹å®šä¿¡æ¯
            if (d.type === 'Metric') {
                content += `
                    <div class="detail-item">
                        <div class="detail-label">é‡è¦ç­‰çº§</div>
                        <div class="detail-value">${d.importance || 'P2'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æ•æ„Ÿçº§åˆ«</div>
                        <div class="detail-value">${d.sensitivity || 'å†…éƒ¨'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è®¡ç®—å…¬å¼</div>
                        <div class="detail-value">${d.formula || 'æ— '}</div>
                    </div>
                `;
            } else if (d.type === 'Table') {
                content += `
                    <div class="detail-item">
                        <div class="detail-label">æ•°æ®åº“</div>
                        <div class="detail-value">${d.database || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æ•æ„Ÿçº§åˆ«</div>
                        <div class="detail-value">${d.sensitivity || 'å†…éƒ¨'}</div>
                    </div>
                `;
            }

            // æ·»åŠ è¡€ç¼˜ä¿¡æ¯
            const upstreams = graphData.links.filter(l => l.target.id === d.id);
            const downstreams = graphData.links.filter(l => l.source.id === d.id);

            if (upstreams.length > 0) {
                content += `
                    <div class="detail-item">
                        <div class="detail-label">ä¸Šæ¸¸ä¾èµ– (${upstreams.length})</div>
                        <div class="detail-value">
                            ${upstreams.map(l => `${l.source.name} (${l.type})`).join('<br>')}
                        </div>
                    </div>
                `;
            }

            if (downstreams.length > 0) {
                content += `
                    <div class="detail-item">
                        <div class="detail-label">ä¸‹æ¸¸å½±å“ (${downstreams.length})</div>
                        <div class="detail-value">
                            ${downstreams.map(l => `${l.target.name} (${l.type})`).join('<br>')}
                        </div>
                    </div>
                `;
            }

            detailContent.innerHTML = content;
            detailPanel.classList.add('visible');
        }

        // æœç´¢åŠŸèƒ½
        function searchNode(keyword) {
            if (!keyword) {
                node.classed('highlighted', false).classed('dimmed', false);
                link.classed('highlighted', false).classed('dimmed', false);
                return;
            }

            keyword = keyword.toLowerCase();
            const matchedNodes = graphData.nodes.filter(n => 
                n.name.toLowerCase().includes(keyword) || 
                n.id.toLowerCase().includes(keyword)
            );

            if (matchedNodes.length > 0) {
                // é«˜äº®åŒ¹é…çš„èŠ‚ç‚¹
                node.classed('highlighted', n => matchedNodes.includes(n))
                    .classed('dimmed', n => !matchedNodes.includes(n));

                // å±…ä¸­åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„èŠ‚ç‚¹
                const firstMatch = matchedNodes[0];
                const transform = d3.zoomIdentity
                    .translate(svg.node().clientWidth / 2 - firstMatch.x, svg.node().clientHeight / 2 - firstMatch.y)
                    .scale(1.5);

                svg.transition()
                    .duration(750)
                    .call(d3.zoom().transform, transform);
            }
        }

        // å¯¼å‡ºåŠŸèƒ½
        function exportGraph() {
            const choice = confirm('é€‰æ‹©ç¡®å®šå¯¼å‡ºä¸ºSVGï¼Œå–æ¶ˆå¯¼å‡ºä¸ºPNG');
            
            if (choice) {
                // å¯¼å‡ºSVG
                const svgData = new XMLSerializer().serializeToString(svg.node());
                const blob = new Blob([svgData], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'metric-lineage.svg';
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // å¯¼å‡ºPNG
                alert('PNGå¯¼å‡ºåŠŸèƒ½éœ€è¦é¢å¤–çš„åº“æ”¯æŒ');
            }
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            sidebar.classList.toggle('collapsed');
            mainContainer.classList.toggle('expanded');
            
            // é‡æ–°è®¡ç®—SVGå°ºå¯¸
            setTimeout(() => {
                const width = mainContainer.clientWidth;
                const height = mainContainer.clientHeight;
                svg.attr('width', width).attr('height', height);
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }, 300);
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadData(selectedNode ? selectedNode.id : 'DAU');
        });

        document.getElementById('layoutBtn').addEventListener('click', () => {
            simulation.alpha(1).restart();
        });

        document.getElementById('exportBtn').addEventListener('click', exportGraph);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchNode(e.target.value);
        });

        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('detailPanel').classList.remove('visible');
            node.classed('highlighted', false).classed('dimmed', false);
            link.classed('highlighted', false).classed('dimmed', false);
        });

        // ç¼©æ”¾æ§åˆ¶
        document.getElementById('zoomIn').addEventListener('click', () => {
            svg.transition().call(d3.zoom().scaleBy, 1.3);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            svg.transition().call(d3.zoom().scaleBy, 0.7);
        });

        document.getElementById('zoomReset').addEventListener('click', () => {
            svg.transition().call(d3.zoom().transform, d3.zoomIdentity);
        });

        // ç­›é€‰åŠŸèƒ½
        document.querySelectorAll('.checkbox-item input').forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });

        function applyFilters() {
            const selectedTypes = Array.from(document.querySelectorAll('.checkbox-item input:checked'))
                .map(cb => cb.value);

            node.style('display', d => selectedTypes.includes(d.type) || selectedTypes.includes(d.sensitivity) || selectedTypes.includes(d.importance) ? 'block' : 'none');
            
            link.style('display', l => {
                const sourceVisible = selectedTypes.includes(l.source.type);
                const targetVisible = selectedTypes.includes(l.target.type);
                return sourceVisible && targetVisible ? 'block' : 'none';
            });
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initSVG();
            loadData('DAU');
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´
        window.addEventListener('resize', () => {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg.attr('width', width).attr('height', height);
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>